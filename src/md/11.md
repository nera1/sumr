---
filename: 11.md
tags:
  - spring
  - springboot
  - jmeter
  - postgresql
  - trgm
  - pg_trgm
  - pgroonga
category: postgresql
created: Sat, 06 Sep 2025 02:28:08 GMT
title: 실행 계획
---

## JPA repository

```java
    @Query(value = """
            SELECT *
            FROM channels
            WHERE REPLACE(LOWER(name), ' ', '')
                  LIKE CONCAT('%', REPLACE(LOWER(:keyword), ' ', ''), '%')
              AND (
                  :cursor IS NULL
                  OR (
                      :asc = true AND public_id > :cursor
                      OR :asc = false AND public_id < :cursor
                  )
              )
            ORDER BY
                CASE WHEN :asc = true THEN public_id END ASC,
                CASE WHEN :asc = false THEN public_id END DESC
            LIMIT :size
            """, nativeQuery = true)
    List<Channel> search(
            @Param("keyword") String keyword,
            @Param("cursor") String cursor,
            @Param("asc") boolean asc,
            @Param("size") int size);
```

- 위 메서드의 성능을 Jmeter로 테스트 했습니다

## Jmeter Test

<p style="display:flex;justify-content:center">
  <img src="../../images/11/1.png" width="100%" alt="image"/>
</p>

- P99(전체 요청의 99%)가 400 ~ 600ms 에서 처리됩니다
- GIN 인덱스와 여러 PostgreSQL 확장을 설치했는데도 예상보다 빠르지 않아 쿼리를 점검하였습니다

## SQL

```sql
-- $1 :: text      -- keyword
-- $2 :: text      -- cursor (public_id와 같은 타입)
-- $3 :: boolean   -- asc (true=오름차순, false=내림차순)
-- $4 :: integer   -- size (LIMIT)
SELECT *
FROM channels
WHERE REPLACE(LOWER(name), ' ', '') LIKE '%' || REPLACE(LOWER($1), ' ', '') || '%'
  AND (
    $2 IS NULL
    OR (
         ($3 AND public_id > $2)
      OR (NOT $3 AND public_id < $2)
    )
  )
ORDER BY
    CASE WHEN $3 THEN public_id END ASC,
    CASE WHEN NOT $3 THEN public_id END DESC
LIMIT $4;
```

- 채널의 name을 소문자로 치환하고 공백문자를 모두 제거한 뒤 %keyword% 형태로 LIKE 검색을 시행합니다
- cursor 값이 존재한다면, 그 값을 기준으로 오름차순, 내림차순의 데이터를 검색합니다

## 실행 계획

```sql
EXPLAIN (ANALYZE, BUFFERS)
SELECT *
FROM public.channels
WHERE replace(lower(name),' ','') ILIKE '%' || replace(lower('채널'),' ','') || '%'
ORDER BY public_id ASC
LIMIT 10;
```

- 위 실행계획은 '채널' 이라는 키워드를 부분검색하는 실행 계획입니다

```bash
Limit (cost=0.42..54.08 rows=10 width=132) (actual time=10.052..21.531 rows=10 loops=1)
Buffers: shared hit=1330 -> Index Scan using idx_channel_public_id on channels (cost=0.42..5393.56 rows=1005 width=132)
(actual time=10.050..21.525 rows=10 loops=1)
Filter: (replace(lower((name)::text), ' '::text, ''::text) ~~* '%채널%'::text)
Rows Removed by Filter: 1674 Buffers: shared hit=1330
Planning: Buffers: shared hit=107 Planning Time: 12.680 ms Execution Time: 22.112 ms
```

- 실행계획의 결과는 검색에 GIN 인덱스를 이용하지 않고있음을 보여줍니다

## LIKE 검색에 GIN 인덱스, pg_trgm을 사용하지 않는 이유

```sql
-- pg_trgm 설치
CREATE EXTENSION IF NOT EXISTS pg_trgm;
-- GIN Index 생성, gin_trgm_ops 옵션
CREATE INDEX IF NOT EXISTS idx_channel_name_trgm
  ON channels USING gin (name gin_trgm_ops);
-- ANALYZE는 테이블 내용 통계를 **pg_statistic**에 수집/갱신하고, 플래너가 인덱스 사용 여부를 더 정확히 판단
ANALYZE channels;
```

- GIN 인덱스 생성 시 channels 테이블의 `name` 컬럼에 대해서 인덱스를 생성하고 있습니다
- `replace(lower(name),' ','')` 형태의 쿼리와 인덱스(`name`) 형태의 불일치로 GIN 인덱스를 사용하지 못합니다

```sql
DROP INDEX CONCURRENTLY IF EXISTS idx_channel_name_trgm;

CREATE INDEX IF NOT EXISTS idx_channels_name_trgm
  ON public.channels
  USING gin ( (replace(lower(name), ' ', '')) gin_trgm_ops );
```

- 기존 인덱스를 제거하고 쿼리에 맞는 형태로 인덱스를 재생성합니다
- 인덱스 재생성 후 아래 실행계획을 확인했습니다

```sql
EXPLAIN (ANALYZE, BUFFERS)
SELECT public_id
FROM public.channels
WHERE replace(lower(name),' ','') LIKE '%' || replace(lower('채널'),' ','') || '%'
LIMIT 50;
```

```bash
Limit (cost=0.25..42.94 rows=50 width=37) (actual time=64.456..65.418 rows=50 loops=1)
Buffers: shared hit=40 -> Bitmap Heap Scan on channels
(cost=0.25..858.27 rows=1005 width=37) (actual time=64.455..65.411 rows=50 loops=1)
Recheck Cond: (replace(lower((name)::text), ' '::text, ''::text) ~~* '%채널%'::text)
Heap Blocks: exact=40 Buffers: shared hit=40 -> Bitmap Index Scan on idx_channel_name_norm_pgroonga
(cost=0.00..0.00 rows=1005 width=0)
(actual time=64.393..64.393 rows=427 loops=1)
Index Cond: (replace(lower((name)::text), ' '::text, ''::text) ~~* '%채널%'::text)
Planning: Buffers: shared hit=1 Planning Time: 17.071 ms Execution Time: 69.417 ms
```

- 여전히 재생성한 GIN 인덱스를 사용하지 않고, 다른 Pgroonga의 인덱스를 사용하고 있습니다

### pg_trgm

[GIN 인덱스, pg_trgm, PGroonga 포스트](/post/10)

- pg_trgm 은 그 이름처럼 trigram(3글자 토큰)으로 구성된 GIN 인덱스를 사용합니다
- 3글자 길이 미만의 단어 검색에 대해 인덱스를 제대로 활용하지 못하고 있습니다

```sql
EXPLAIN (ANALYZE, BUFFERS)
SELECT public_id
FROM public.channels
WHERE replace(lower(name),' ','') LIKE '%' || replace(lower('고양이'),' ','') || '%'
LIMIT 50;
```

```bash
Limit  (cost=6.68..17.78 rows=10 width=37) (actual time=0.113..0.411 rows=50 loops=1)
  Buffers: shared hit=16
  ->  Bitmap Heap Scan on channels  (cost=6.68..17.78 rows=10 width=37) (actual time=0.111..0.405 rows=50 loops=1)
        Recheck Cond: (replace(lower((name)::text), ' '::text, ''::text) ~~* '%고양이%'::text)
        Heap Blocks: exact=11
        Buffers: shared hit=16
        ->  Bitmap Index Scan on idx_channel_name_trgm  (cost=0.00..6.68 rows=10 width=0) (actual time=0.072..0.073 rows=389 loops=1)
              Index Cond: (replace(lower((name)::text), ' '::text, ''::text) ~~* '%고양이%'::text)
              Buffers: shared hit=5
Planning:
  Buffers: shared hit=169
Planning Time: 2.576 ms
Execution Time: 0.559 ms
```

- 검색 단어가 3단어를 넘어가자 idx_channel_name_trgm 을 제대로 이용하고 있음을 확인할 수 있습니다

## 결과

<p style="display:flex;justify-content:center">
  <img src="../../images/11/2.png" width="100%" alt="image"/>
</p>

- 3글자 미만의 검색은 PGroonga 인덱스를 활용
- 3글자 이상의 검색은 GIN + pg_trgm 인덱스를 활용