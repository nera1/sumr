---
filename: 7.md
tags:
  - spring
  - springboot
  - caffeine
  - websocket
category: caffeine
created: Tue, 29 Jul 2025 14:18:13 GMT
title: 실시간 참여자 집계
preview: images/5/1.png
---

<p style="display:flex;justify-content:center">
  <img src="../../images/7/1.png" width="45%" alt="image"/>
</p>

- 현재 메인 페이지에서 `실시간 인기 채널` 및 `참여자 많은 채널`리스트를 제공하고 있습니다
- `실시간 인기 채널`이란 실시간 채팅중인 참여자가 가장 많은 채널들입니다
- `참여자 많은 채널`이란 채팅 채널에 참여한 인원이 가장 많은 채널들입니다
- 채팅 채널에 입장하기 위해서는 **참여**가 필수이며, 실시간 채팅충인 참여자는 전체 참여자 수 보다 작을 수 있습니다

## 문제

- 채팅에 참여하기 위해서는 Handshake및 채널의 endpoint에 Subscribe하는 과정이 필수입니다
- 채팅에 실시간 채팅중인 참여자를 집계하기 위해 Subscribe의 횟수를 집계하고자 합니다
- 한 사용자가 브라우저의 탭을 여러개 열어도 한 사용자로만 집계해야합니다

## 첫번째 시도

<p style="display:flex;justify-content:center">
  <img src="../../images/7/2.png" width="60%" alt="image"/>
</p>

- 현재 `ChannelInterceptor`에서 메세지 발신자의 인증 단계에서 발신자의 ID를 확인 가능하므로 Set에 ID를 저장하는 방식으로 구성하였습니다
- 같은 사용자가 한 채널에서 탭을 여러개 열어 `SUBSCRIBE`메세지가 여러번 전달되어도 `Set`자료구조의 특성으로 하나의 사용자만 집계됩니다
- `Set`의 크기가 해당 채널의 실시간 참여자입니다
- `UNSUBESCRIBE`메세지를 수신하면, 해당 `Set`자료구조에서 발신자의 ID를 제거합니다

### 문제점

- 한 사용자가 한 채널에서 탭을 N개 열었다고 가정 했을 때, N개의 탭 중 1개의 탭에서 `UNSUBSCRIBE`가 발생할 수 있습니다
- 한번의 `UNSUBSCRIBE`메세지로 인해 `Set`자료구조에 있던 발신자의 ID가 제거되어 해당 사용자는 채널에 참여하고 있음에도 실시간 참여자 수에 집계되지 않습니다
- 브라우저의 비정상적인 종료로 인해 `UNSUBSCRIBE`메세지를 수신하지 못하면 해당 `Set`에 발신자의 ID가 계속 남아있게 됩니다

## 두번째 시도

<p style="display:flex;justify-content:center">
  <img src="../../images/7/3.png" width="60%" alt="image"/>
</p>

- 브라우저의 탭마다 randomId를 생성하여 `SUBSCRIBE`메세지와 함께 전달됩니다
- 한 사용자가 탭을 마음대로 닫거나 열어도 실시간 참여자 수는 한명으로만 집계됩니다

### 문제점

- 집계를 위한 자료구조가 훨씬 더 복잡해졌습니다
- 실시간 참여자가 한명 감소하기 위해서는 해당 참여자가 열어놓은 모든 탭 및 브라우저에서 정상적으로 닫히며 `UNSUBSCRIBE`메세지가 수신되어 randomId를 저장하는 Set 자료구조의 크기가 0이 되어야 합니다
  - 테스트 과정에서 이런 이상적인 상황은 거의 발생하지 않았습니다
  - 여전히 `UNSUBSCRIBE`메세지를 정상적으로 수신하지 못해 randomId의 값이 Set에 남아있는 경우가 많았습니다
- **Caffeine**의 만료기한은 entry(key : value)의 데이터 삭제에만 해당됩니다
  - 복잡한 구조의 자료구조의 하위 데이터에는 만료기한을 적용할 수 없어 위 구조의 집계방식은 **Caffeine**의 특성을 잘 이용하지 못합니다

## 세번째 시도

<p style="display:flex;justify-content:center">
  <img src="../../images/7/4.png" width="60%" alt="image"/>
</p>
