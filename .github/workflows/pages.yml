# .github/workflows/pages.yml
name: Deploy to GitHub Pages (Next.js)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      # GitHub Pages를 Actions로 사용하도록 활성화 (404 방지의 핵심)
      - id: configurepages
        uses: actions/configure-pages@v5
        with:
          enablement: true

      # (선택) Next.js 캐시
      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.[jt]s', '**/*.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-

      - run: yarn install --frozen-lockfile

      # Next.js 정적 빌드 + export
      # - output: 'export' 가 설정돼 있다면 build만으로 out/이 생기는 버전도 있으나,
      #   확실히 하기 위해 export를 분리해서 실행합니다.
      - name: Build
        run: yarn build
        env:
          # 필요한 경우 프로젝트에서 참조해 basePath/assetPrefix에 반영할 수 있음
          BASE_PATH: ${{ steps.configurepages.outputs.base_path }}
          EXPORT: 1
          UNOPTIMIZED: 1

      - name: Export static site
        run: |
          if yarn -s run | grep -q "^export"; then
            yarn export
          else
            npx next export
          fi
        env:
          BASE_PATH: ${{ steps.configurepages.outputs.base_path }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    # 배포 잡
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
